generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ── Enums ──

enum InvoiceType {
  NFE
  CTE
  NFSE
}

enum InvoiceDirection {
  received
  issued
}

enum InvoiceStatus {
  received
  confirmed
  rejected
}

enum SyncMethod {
  sefaz
  nsdocs
}

enum SyncStatus {
  running
  completed
  error
}

// ── Models ──

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String
  role         String    @default("user")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  companies    Company[]
}

model Company {
  id           String    @id @default(cuid())
  cnpj         String    @unique
  razaoSocial  String
  nomeFantasia String?
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices          Invoice[]
  nsdocsConfig      NsdocsConfig?
  certificateConfig CertificateConfig?
  syncLogs          SyncLog[]
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([userId])
}

model NsdocsConfig {
  id           String    @id @default(cuid())
  apiToken     String
  companyId    String    @unique
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  autoSync     Boolean   @default(true)
  syncInterval Int       @default(60)
  lastNsu      String?
  lastSyncAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model CertificateConfig {
  id              String    @id @default(cuid())
  companyId       String    @unique
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  pfxData         Bytes
  pfxPassword     String
  serialNumber    String?
  issuer          String?
  subject         String?
  validFrom       DateTime?
  validTo         DateTime?
  cnpjCertificate String?
  environment     String    @default("production")
  lastNsu         String    @default("000000000000000")
  lastSyncAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model SyncLog {
  id           String     @id @default(cuid())
  companyId    String
  company      Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  syncMethod   SyncMethod @default(sefaz)
  status       SyncStatus @default(running)
  newDocs      Int        @default(0)
  updatedDocs  Int        @default(0)
  errorMessage String?
  startedAt    DateTime   @default(now())
  completedAt  DateTime?

  @@index([companyId])
}

model Invoice {
  id             String           @id @default(cuid())
  accessKey      String           @unique
  type           InvoiceType
  direction      InvoiceDirection @default(received)
  number         String
  series         String?
  issueDate      DateTime
  senderCnpj     String
  senderName     String
  recipientCnpj  String?
  recipientName  String?
  totalValue     Float
  status         InvoiceStatus    @default(received)
  xmlContent     String
  companyId      String
  company        Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([companyId])
  @@index([senderCnpj])
  @@index([issueDate])
}
