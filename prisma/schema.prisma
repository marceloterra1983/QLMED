generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String
  role         String    @default("user")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  companies    Company[]
}

model Company {
  id           String    @id @default(cuid())
  cnpj         String    @unique
  razaoSocial  String
  nomeFantasia String?
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices          Invoice[]
  nsdocsConfig      NsdocsConfig?
  certificateConfig CertificateConfig?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model NsdocsConfig {
  id           String    @id @default(cuid())
  apiToken     String
  companyId    String    @unique
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  autoSync     Boolean   @default(true)
  syncInterval Int       @default(60)
  lastNsu      String?
  lastSyncAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model CertificateConfig {
  id              String    @id @default(cuid())
  companyId       String    @unique
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  pfxData         Bytes
  pfxPassword     String
  serialNumber    String?
  issuer          String?
  subject         String?
  validFrom       DateTime?
  validTo         DateTime?
  cnpjCertificate String?
  environment     String    @default("production")
  lastNsu         String    @default("000000000000000")
  lastSyncAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model SyncLog {
  id           String    @id @default(cuid())
  companyId    String
  syncMethod   String    @default("sefaz")
  status       String    @default("running")
  newDocs      Int       @default(0)
  updatedDocs  Int       @default(0)
  errorMessage String?
  startedAt    DateTime  @default(now())
  completedAt  DateTime?
}

model Invoice {
  id             String   @id @default(cuid())
  accessKey      String   @unique
  type           String   // NFE, CTE, NFSE
  direction      String   @default("received") // received, issued
  number         String
  series         String?
  issueDate      DateTime
  senderCnpj     String
  senderName     String
  recipientCnpj  String
  recipientName  String
  totalValue     Float
  status         String   @default("received") // received, confirmed, rejected
  xmlContent     String   // Full XML stored as text
  companyId      String
  company        Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}
